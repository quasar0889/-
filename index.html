<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>⚫︎ BOUNTY TERMINAL ⚫︎</title>
<style>
/* ----------------- 黒背景・緑白文字・昔の日本サイト風 ----------------- */
body {
  background-color: #000;
  color: #fff;
  font-family: "MS Gothic", "Courier New", monospace;
  font-size: 12px;
  margin: 0;
  padding: 0;
}

.container {
  width: 800px;
  margin: 0 auto;
  padding: 10px;
}

header {
  border-bottom: 2px solid #33FF33;
  padding-bottom: 5px;
  margin-bottom: 10px;
}

header h1 {
  font-size: 16px;
  color: #33FF33;
  margin: 0;
}

input, textarea, select, button {
  font-family: "MS Gothic", monospace;
  font-size: 12px;
  border: 1px solid #33FF33;
  background-color: #000;
  color: #fff;
  padding: 2px 4px;
  margin: 2px 0;
}

button {
  background-color: #000;
  color: #33FF33;
  cursor: pointer;
  border: 1px solid #33FF33;
}

button:hover {
  background-color: #003300;
}

ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

li {
  border-bottom: 1px dotted #33FF33;
  padding: 2px 0;
}

a {
  color: #33FF33;
  text-decoration: underline;
}

a:hover {
  color: #FFFFFF;
}

.flex {
  display: flex;
  gap: 10px;
}

.flex > div {
  flex: 1;
}

.green { color: #33FF33; }
.white { color: #FFFFFF; }

.section-title {
  border-bottom: 1px solid #33FF33;
  margin-bottom: 4px;
  padding-bottom: 2px;
  font-weight: bold;
}
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>BOUNTY TERMINAL</h1>
  </header>

  <section id="authSection">
    <input id="username" placeholder="username">
    <input id="password" placeholder="password" type="password">
    <button id="btnLogin">LOGIN</button>
    <button id="btnRegister">REGISTER</button>
    <div id="meInfo" class="green"></div>
  </section>

  <section class="flex">
    <div>
      <div class="section-title">BOUNTY LIST</div>
      <ul id="bountyList"></ul>
    </div>
    <div>
      <div class="section-title">CREATE BOUNTY</div>
      <input id="title" placeholder="TITLE"><br>
      <textarea id="description" placeholder="DESCRIPTION"></textarea><br>
      <input id="reward" placeholder="REWARD" type="number"><br>
      <button id="btnCreate">POST</button>

      <div class="section-title">TRANSACTIONS</div>
      <ul id="txnList"></ul>

    <!-- 依頼詳細表示エリア -->
<div id="bountyDetail" style="border:1px solid #33FF33; padding:5px; margin-top:10px; display:none;">
  <div id="detailTitle" class="green"></div>
  <div id="detailDescription" class="white"></div>
  <div id="detailReward" class="green"></div>
  <div id="detailImage"></div>
  <div id="detailCountdown" class="white"></div>
</div>
</div>
  </section>
</div>

<script>
// ==================== SOCKET.IO ====================
const socket = io();

// ==================== STATE ====================
let token = localStorage.getItem('token') || null;
let me = null;

// ==================== ELEMENTS ====================
const el = id => document.getElementById(id);
const bountyListEl = el('bountyList');
const txnListEl = el('txnList');
const meInfoEl = el('meInfo');

// ==================== API HELPER ====================
async function api(path, opts={}) {
  const headers = opts.headers||{};
  if(token) headers['Authorization'] = 'Bearer '+token;
  if(!opts.body || opts.body instanceof FormData) {
    // FormDataはそのまま
  } else {
    headers['Content-Type']='application/json';
    opts.body = JSON.stringify(opts.body);
  }
  const res = await fetch('/api'+path,{...opts, headers});
  return res.json().then(j=>{ if(!res.ok) throw j; return j; });
}

// ==================== AUTH ====================
async function loadMe() {
  if(!token) return showAnon();
  try {
    me = await api('/me');
    showMe();
    loadTxns();
  } catch { token=null; localStorage.removeItem('token'); showAnon(); }
}
function showAnon(){ meInfoEl.textContent='[Not Logged In]'; }
function showMe(){ meInfoEl.textContent=`[${me.username}] Balance: ${me.balance} pt`; }

// ==================== BOUNTIES ====================
async function loadBounties() {
  const bounties = await api('/bounties').catch(()=>[]);
  bountyListEl.innerHTML='';
  bounties.forEach(b=>{
    const li = document.createElement('li');
    li.innerHTML = `#<span class="green">${b.id}</span> [${b.status}] <span class="green">${b.title}</span> (<span class="green">${b.reward}</span>pt) by <span class="white">${b.created_by_name}</span>`;

    // 応募ボタン
    if(me && b.status==='open' && me.id!==b.created_by) {
      const btnApply = document.createElement('button');
      btnApply.textContent='APPLY';
      btnApply.onclick = async ()=>{ await api(`/bounties/${b.id}/apply`, {method:'POST'}); alert('Applied!'); };
      li.appendChild(btnApply);
    }

    // 承認ボタン（依頼主のみ）
    if(me && me.id===b.created_by && b.status==='open') {
      const btnComplete = document.createElement('button');
      btnComplete.textContent='COMPLETE';
      btnComplete.onclick = async ()=>{
        const winnerId = prompt('Enter winner user id');
        if(!winnerId) return;
        await api(`/bounties/${b.id}/complete`, {method:'POST', body:{winnerId:parseInt(winnerId,10)}});
        alert('Bounty Completed!'); loadBounties(); loadMe();
      };
      li.appendChild(btnComplete);

      const btnApps = document.createElement('button');
      btnApps.textContent='APPLICANTS';
      btnApps.onclick = async ()=>{
        const apps = await api(`/bounties/${b.id}/applications`);
        alert(apps.map(a=>`${a.username} [${a.status}]`).join('\n') || 'No applicants');
      };
      li.appendChild(btnApps);
    }

    // コメント
    const btnComments = document.createElement('button');
    btnComments.textContent='COMMENTS';
    btnComments.onclick = async ()=>{
      const comments = await api(`/bounties/${b.id}/comments`);
      const msg = comments.map(c=>`${c.username}: ${c.message}`).join('\n') || 'No comments';
      const newMsg = prompt(msg+'\n\nEnter new comment (Cancel to skip)');
      if(newMsg) { await api(`/bounties/${b.id}/comments`, {method:'POST', body:{message:newMsg}}); alert('Comment posted!'); }
    };
    li.appendChild(btnComments);

    // ファイルアップロード
    const btnUpload = document.createElement('button');
    btnUpload.textContent='UPLOAD';
    btnUpload.onclick = async ()=>{
      const fileInput = document.createElement('input'); fileInput.type='file';
      fileInput.onchange = async ()=>{
        if(!fileInput.files.length) return;
        const form = new FormData();
        form.append('file', fileInput.files[0]);
        await fetch(`/api/bounties/${b.id}/upload`, {method:'POST', headers:{'Authorization':'Bearer '+token}, body:form});
        alert('File uploaded!');
      };
      fileInput.click();
    };
    li.appendChild(btnUpload);

    bountyListEl.appendChild(li);
  });
}

// ==================== TRANSACTIONS ====================
async function loadTxns() {
  if(!me) return;
  const txns = await api('/transactions/me').catch(()=>[]);
  txnListEl.innerHTML='';
  txns.forEach(t=>{
    const li = document.createElement('li');
    li.innerHTML=`<span class="white">${t.created_at}</span> <span class="green">${t.kind}</span> <span class="green">${t.change_amount}</span> pt`;
    txnListEl.appendChild(li);
  });
}

// ==================== SOCKET ====================
socket.on('new_bounty', loadBounties);
socket.on('bounty_completed', loadBounties);
socket.on('new_application', loadBounties);
socket.on('new_comment', loadBounties);
socket.on('new_attachment', loadBounties);

// ==================== EVENT LISTENERS ====================
el('btnLogin').addEventListener('click', async ()=>{
  const u = el('username').value, p = el('password').value;
  try { const res = await api('/login',{method:'POST',body:{username:u,password:p}}); token=res.token; localStorage.setItem('token', token); me=res.user; showMe(); loadBounties(); }
  catch(e){ alert(e.error || 'Login failed'); }
});

el('btnRegister').addEventListener('click', async ()=>{
  const u = el('username').value, p = el('password').value;
  try { const res = await api('/register',{method:'POST',body:{username:u,password:p}}); token=res.token; localStorage.setItem('token', token); me=res.user; showMe(); loadBounties(); }
  catch(e){ alert(e.error || 'Register failed'); }
});

el('btnCreate').addEventListener('click', async ()=>{
  const title=el('title').value, desc=el('description').value, reward=parseInt(el('reward').value,10);
  if(!title||!reward){ alert('Invalid input'); return; }
  try{ await api('/bounties',{method:'POST', body:{title,description:desc,reward}}); el('title').value=''; el('description').value=''; el('reward').value=''; loadBounties(); loadMe(); }
  catch(e){ alert(e.error || 'Failed'); }
});
// 詳細表示要素
const bountyDetail = el('bountyDetail');
const detailTitle = el('detailTitle');
const detailDescription = el('detailDescription');
const detailReward = el('detailReward');
const detailImage = el('detailImage');
const detailCountdown = el('detailCountdown');

let countdownInterval = null;

function showBountyDetail(b) {
  detailTitle.textContent = b.title;
  detailDescription.textContent = b.description;
  detailReward.textContent = `報酬: ${b.reward} pt`;
  
  if(b.attachment_url) {
    detailImage.innerHTML = `<img src="${b.attachment_url}" alt="attachment" style="max-width:100%;">`;
  } else {
    detailImage.innerHTML = '';
  }
  
  // 残り時間カウントダウン
  if(countdownInterval) clearInterval(countdownInterval);
  function updateCountdown() {
    const now = new Date();
    const end = new Date(b.deadline); // deadlineはサーバーからISO文字列で取得
    let diff = Math.floor((end - now) / 1000); // 秒
    if(diff < 0) diff = 0;
    const h = String(Math.floor(diff/3600)).padStart(2,'0');
    const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
    const s = String(diff%60).padStart(2,'0');
    detailCountdown.textContent = `残り時間: ${h}:${m}:${s}`;
  }
  updateCountdown();
  countdownInterval = setInterval(updateCountdown,1000);
  
  bountyDetail.style.display = 'block';
}

// bountyListの各liクリックで詳細表示
function createBountyLi(b) {
  const li = document.createElement('li');
  li.innerHTML = `#<span class="green">${b.id}</span> [${b.status}] <span class="green">${b.title}</span> (<span class="green">${b.reward}</span>pt) by <span class="white">${b.created_by_name}</span>`;
  
  li.style.cursor = 'pointer';
  li.onclick = ()=>showBountyDetail(b);

  return li;
}

// loadBounties内でliを作成する部分を
// bountyListEl.appendChild(createBountyLi(b));

// ==================== INIT ====================
loadMe(); loadBounties();
</script>
</body>
</html>
